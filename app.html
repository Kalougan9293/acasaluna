<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H5J9RYBSZL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-H5J9RYBSZL');
    </script>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://french-sommelier.com/">
    <meta property="og:title" content="A Casa Luna - Accords Mets-Vins">
    <meta property="og:description" content="L'expert vin de votre restaurant.">
    <meta property="og:image" content="https://french-sommelier.com/sommelier.png">

    <script id="cookieyes" type="text/javascript" src="https://cdn-cookieyes.com/client_data/0edc491f3fd98d681d2d2bd990d55812/script.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <title>A Casa Luna</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üç∑</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Montserrat:wght@300;400;600&family=Cinzel:wght@400;700&display=swap');
        
        /* THEME LUXE A CASA LUNA */
        :root {
            --color-bg-dark: #1a0f0a;
            --color-bg-medium: #2c1a12;
            --color-bg-accent: #3a1c14;
            --color-text-gold-light: #f3e7c8;
            --color-text-gold-dark: #bfa37c;
            --color-btn-brown: #5d3a2e;
            --color-text-brown-dark: #4a2c20;
        }

        body { transition: background 0.8s ease; font-family: 'Playfair Display', serif; }
        
        body.theme-wine { 
            background: linear-gradient(135deg, var(--color-bg-accent) 0%, var(--color-bg-medium) 50%, var(--color-bg-dark) 100%);
            background-attachment: fixed;
        }
        body.theme-dark { background: linear-gradient(135deg, #2a2a2a 0%, #000000 100%); }
        
        .text-gradient-gold {
            background: linear-gradient(to right, var(--color-text-gold-light), var(--color-text-gold-dark), var(--color-text-gold-light));
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 5s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }

        .gold-btn { background: linear-gradient(to bottom, #d4af37, #8a6e2f); box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: all 0.5s ease; color: white; border: 1px solid #fbf5e6; }
        .gold-btn:active { transform: scale(0.98); }
        
        .avatar-wrapper { position: relative; width: 12rem; height: 12rem; margin: 0 auto; transition: transform 0.3s; cursor: pointer; z-index: 10; }
        .avatar-wrapper:hover { transform: scale(1.02); }
        .avatar-circle { width: 100%; height: 100%; border-radius: 50%; border: 3px solid #d4c5a5; overflow: hidden; position: relative; z-index: 20; background: var(--color-bg-medium); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .sommelier-banner {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            background: linear-gradient(to right, #d4af37, #8a6e2f);
            color: #2c1a12;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 0.75rem;
            padding: 4px 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            z-index: 25;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-radius: 2px;
        }

        .pulse-gold { animation: pulseAura 2s infinite; }
        @keyframes pulseAura { 0% { box-shadow: 0 0 20px rgba(212, 197, 165, 0.3); } 50% { box-shadow: 0 0 60px rgba(212, 197, 165, 0.7); } 100% { box-shadow: 0 0 20px rgba(212, 197, 165, 0.3); } }
        
        .wine-fill { animation: fillGlass 2s infinite alternate; }
        @keyframes fillGlass { 0% { height: 0%; } 100% { height: 75%; } }
        
        .main-card {
            background: #fdfbf7;
            border: 1px solid rgba(212, 197, 165, 0.3);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            padding-bottom: 10px; 
        }

        #response-card { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.8s ease-out, opacity 0.5s ease; 
            opacity: 0; 
            color: #4a2c20; 
        }
        #response-card.visible { max-height: 4000px; opacity: 1; margin-top: 1.5rem; border-top: 2px solid rgba(74, 44, 32, 0.1); padding-top: 1.5rem; }
        
        .fade-in-line { animation: fadeIn 0.5s ease forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        .response-box {
            color: #4a2c20 !important;
            background-color: #fffefc;
            border-left: 4px solid #4a2c20;
        }
        .response-box h3 { color: #4a2c20; font-family: 'Cinzel', serif; font-weight: 700; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
        .response-box p, .response-box li { font-family: 'Montserrat', sans-serif; color: #4a2c20; }

        .lang-menu:hover .lang-dropdown { opacity: 1; visibility: visible; transform: translateY(0); }
        .lang-dropdown { opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.3s ease; }

        .switch-btn { background: var(--color-btn-brown); border: 1px solid #d4af37; color: #fdfbf7; font-size: 0.8rem; font-weight: 600; padding: 0.6rem 1rem; border-radius: 9999px; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; display: inline-block; cursor: pointer; font-family: 'Montserrat', sans-serif; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .switch-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3); background: #6b4235; }
        .switch-container { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee; }
        
        .glass-icon { width: 16px; height: 16px; margin-right: 2px; }
        
        .tag-btn { font-size: 0.65rem; padding: 0.5rem 0.2rem; border: 1px solid #e5e7eb; border-radius: 12px; background: white; color: #4a2c20; cursor: pointer; transition: all 0.2s; font-family: 'Montserrat', sans-serif; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .tag-btn:hover { background: #fdf2f8; border-color: #d4af37; transform: translateY(-1px); }
        
        .feedback-btn { font-size: 1.2rem; padding: 0.5rem; cursor: pointer; transition: transform 0.2s; }
        .feedback-btn.selected { transform: scale(1.2); pointer-events: none; opacity: 0.5; }
        
        .modal-overlay { background-color: rgba(26, 15, 10, 0.97); backdrop-filter: blur(8px); }
        
        .menu-category { margin-bottom: 1.5rem; }
        .menu-category h3 { color: #d4af37; font-family: 'Cinzel', serif; font-size: 1.3rem; border-bottom: 2px solid #d4af37; padding-bottom: 0.5rem; margin-bottom: 1rem; font-weight: 700; letter-spacing: 0.05em; }
        .menu-item { display: flex; align-items: center; padding: 0.8rem; border-bottom: 1px solid #3d2419; cursor: pointer; transition: background 0.2s; }
        .menu-item:hover { background: linear-gradient(to right, rgba(212, 175, 55, 0.15), transparent); }
        .menu-item input { margin-right: 15px; accent-color: #d4af37; transform: scale(1.4); }
        .menu-item span { font-family: 'Montserrat', sans-serif; font-size: 1rem; color: #f3e7c8; }
    </style>
</head>
<body class="theme-wine text-white min-h-screen flex flex-col items-center p-6 text-center relative">

    <div class="absolute top-6 left-6 z-50">
        <div class="relative lang-menu">
            <button id="current-lang-btn" class="w-10 h-10 rounded-full border border-[#d4c5a5]/50 bg-black/30 flex items-center justify-center text-xl hover:bg-[#d4c5a5]/20 transition-colors">üá´üá∑</button>
            <div class="lang-dropdown absolute top-12 left-0 bg-[#2c1a12] border border-[#d4c5a5] rounded-xl overflow-hidden shadow-xl w-12 flex flex-col">
                <button onclick="setLanguage('fr')" class="h-10 w-full hover:bg-[#d4c5a5]/20 text-xl flex items-center justify-center">üá´üá∑</button>
                <button onclick="setLanguage('en')" class="h-10 w-full hover:bg-[#d4c5a5]/20 text-xl flex items-center justify-center">üá∫üá∏</button>
            </div>
        </div>
    </div>

    <div class="absolute top-6 right-6 z-50">
        <button onclick="toggleTheme()" class="w-10 h-10 rounded-full border border-[#d4c5a5]/50 text-[#d4c5a5] bg-black/30 flex items-center justify-center hover:bg-[#d4c5a5] hover:text-black transition-colors">
            <span id="theme-icon">üåô</span>
        </button>
    </div>

    <header class="mt-8 mb-8 relative px-4">
        <h1 id="main-title" class="text-3xl md:text-5xl font-bold text-gradient-gold uppercase tracking-[0.15em] mb-2 leading-tight font-[Cinzel] drop-shadow-sm whitespace-nowrap">A CASA LUNA</h1>
        <h2 id="subtitle" class="text-sm md:text-2xl text-[#d4c5a5] font-bold tracking-[0.25em] uppercase mb-3 font-[Cinzel]">ACCORDS METS-VINS</h2>
        <p class="text-xs md:text-sm text-[#d4c5a5]/80 font-light tracking-widest italic font-serif">Le French Sommelier</p>
    </header>

    <div class="mb-8 relative group z-30">
        <div class="avatar-wrapper" onclick="handleAvatarClick()">
            <div id="avatar-circle" class="avatar-circle">
                <img src="casalunaa.png" alt="Sommelier" class="w-full h-full object-cover">
            </div>
            <div class="sommelier-banner">French Sommelier</div>
        </div>
    </div>

    <div class="w-full max-w-md main-card rounded-[2rem] px-6 pt-6 relative z-20">
        
        <div class="relative mb-2">
            <input type="text" id="search-bar" placeholder="Ou √©crivez ici..." class="w-full border-2 border-[#4a2c20]/20 rounded-2xl p-4 pr-12 focus:outline-none focus:border-[#d4af37] transition-colors text-lg font-sans bg-white text-[#4a2c20] placeholder-[#4a2c20]/40 shadow-inner">
            <div id="clear-btn" onclick="clearInput()" class="absolute right-12 top-5 cursor-pointer text-gray-400 hover:text-[#4a2c20] hidden font-bold text-xl px-2">‚úï</div>
            <div onclick="demanderIA()" class="absolute right-4 top-5 cursor-pointer text-[#4a2c20] hover:text-[#d4af37] transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
        </div>

        <div id="quick-actions" class="flex flex-col gap-2 mb-2 px-1 transition-opacity duration-300"></div>
        
        <div id="loader" class="hidden flex flex-col items-center py-4 mb-2">
            <div class="w-10 h-14 border-2 border-[#4a2c20] rounded-b-lg relative overflow-hidden shadow-md">
                <div class="wine-fill absolute bottom-0 left-0 w-full bg-[#800020]"></div>
            </div>
            <p id="loader-text" class="text-[#4a2c20] text-xs mt-3 font-bold uppercase tracking-widest">Recherche...</p>
        </div>

        <button onclick="openMenuModal()" id="photo-btn" class="gold-btn w-full py-5 rounded-xl flex flex-col items-center justify-center gap-1 active:scale-95 cursor-pointer shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            <span id="photo-label" class="text-white font-bold text-lg md:text-xl uppercase tracking-[0.15em] font-[Cinzel]">Ouvrir la Carte</span>
        </button>

        <div id="response-card" class="text-left space-y-5">
            <div id="response-content"></div>
            
            <div id="switch-buttons" class="switch-container hidden fade-in-line">
                <button onclick="relancerIA('rouge')" class="switch-btn">üç∑ Plut√¥t Rouge</button>
                <button onclick="relancerIA('blanc')" class="switch-btn">ü•Ç Plut√¥t Blanc</button>
                <button onclick="relancerIA('similaire')" class="switch-btn">‚ôªÔ∏è Similaire</button>
                <button onclick="relancerIA('surprends_moi')" class="switch-btn">üé≤ Surprenez-moi</button>
            </div>

            <div id="feedback-container" class="hidden flex flex-col items-center mt-8 fade-in-line pt-4 border-t border-gray-100/50">
                <p class="text-[10px] text-gray-400 italic mb-3 uppercase tracking-widest">Avis ?</p>
                <div class="flex gap-8">
                    <button onclick="sendFeedback('down')" id="btn-down" class="feedback-btn opacity-60 hover:opacity-100 transition-all" title="Je n'aime pas">‚ùå</button>
                    <button onclick="sendFeedback('up')" id="btn-up" class="feedback-btn scale-110 hover:scale-125 transition-all" title="J'appr√©cie">‚úÖ</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-16 mb-8 space-y-3">
        <p class="text-gradient-gold text-lg md:text-xl font-serif italic mb-4 font-semibold">L'art de vivre √† la corse.</p>
        <p class="text-[#d4c5a5]/60 text-[10px] uppercase tracking-[0.2em] font-sans">¬© 2026 Powered by French Sommelier. Tous droits r√©serv√©s.</p>
        <p class="text-[#d4c5a5]/40 text-[9px] uppercase tracking-widest font-sans mt-4">L'abus d'alcool est dangereux pour la sant√©, √† consommer avec mod√©ration.</p>
        <div class="mt-8 flex justify-center gap-6 text-[11px] text-[#d4c5a5] tracking-[0.2em] font-bold">
            <button onclick="toggleLegalModal()" class="hover:text-white border-b border-[#d4c5a5]/50 hover:border-white transition-all pb-1">mentions l√©gales</button>
        </div>
    </footer>

    <div id="menu-modal" class="hidden fixed inset-0 z-[100] flex flex-col items-center justify-center p-4 modal-overlay">
        <div class="bg-[#2c1a12] border-2 border-[#d4c5a5] rounded-2xl w-full max-w-md h-[85vh] flex flex-col relative shadow-[0_0_50px_rgba(0,0,0,0.8)]">
            <div class="p-5 border-b-2 border-[#d4c5a5]/50 flex justify-between items-center bg-[#1a0f0a] rounded-t-xl">
                <h2 class="text-gradient-gold font-bold uppercase tracking-[0.2em] text-xl font-[Cinzel]">Votre Repas</h2>
                <button onclick="closeMenuModal()" class="text-[#d4c5a5] text-3xl hover:text-white transition-colors">&times;</button>
            </div>
            <div id="menu-content" class="flex-1 overflow-y-auto p-6 text-left bg-[#2c1a12]"></div>
            <div class="p-5 border-t-2 border-[#d4c5a5]/50 bg-[#1a0f0a] rounded-b-xl">
                <button onclick="validerMenu()" class="gold-btn w-full py-4 rounded-xl font-bold uppercase tracking-[0.2em] text-lg shadow-lg font-[Cinzel]">
                    Trouver le Vin Id√©al
                </button>
            </div>
        </div>
    </div>

    <div id="legal-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 modal-overlay">
        <div class="bg-[#2c1a12] border-2 border-[#d4c5a5] rounded-xl p-8 max-w-sm w-full relative shadow-[0_0_40px_rgba(0,0,0,0.6)] text-left">
            <button onclick="toggleLegalModal()" class="absolute top-4 right-5 text-[#d4c5a5] text-2xl hover:text-white transition-colors">&times;</button>
            <h3 class="text-gradient-gold font-bold text-center uppercase tracking-[0.2em] mb-8 border-b-2 border-[#d4c5a5]/30 pb-4 font-[Cinzel] text-lg">Mentions L√©gales</h3>
            <div class="space-y-6 text-sm text-[#f3e7c8] font-sans">
                <div>
                    <p class="text-[#d4c5a5] font-bold uppercase mb-2 tracking-wider text-xs">√âditeur</p>
                    <p class="leading-relaxed">Jonathan Seroussi<br>119 rue Jules Parent<br>92500 Rueil Malmaison</p>
                </div>
                <div>
                    <p class="text-[#d4c5a5] font-bold uppercase mb-2 tracking-wider text-xs">Contact</p>
                    <a href="mailto:contact@french-sommelier.com" class="underline hover:text-white transition-colors">contact@french-sommelier.com</a>
                </div>
                <div>
                    <p class="text-[#d4c5a5] font-bold uppercase mb-2 tracking-wider text-xs">H√©bergement</p>
                    <p class="leading-relaxed">Render<br>525 Brannan St, San Francisco, CA 94107, USA</p>
                </div>
                <div class="pt-4 border-t border-[#d4c5a5]/30">
                    <p class="italic text-xs opacity-70">Ce site utilise Google Analytics √† des fins de mesure d'audience anonyme.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MENU AVEC PREFERENCES
        const menuPlats = {
            "ü´í Entr√©es": [
                "Tapenade Givr√©e", "Huile d‚ÄôOlive √† Tartiner", "Terrine de Figatellu", 
                "Foie Gras au Cap Corse", "Loup Effiloch√© et Agrumes", "Crudo de Daurade et C√©drat au Sel",
                "Carpaccio d‚ÄôArtichaut", "Tartare de B≈ìuf au Cap Corse", "Bouillon de Soupe Corse"
            ],
            "üçΩÔ∏è Plats": [
                "Loup √† la Calvaise", "Daurade √† la Boutargue", "Stufatu de Veau aux Olives",
                "Veau aux Olives", "Civet de Sanglier au Sciaccarellu", "Agneau en Cro√ªte d‚ÄôHerbes",
                "Cochon laqu√© au Miel de Ch√¢taigne", "Saint-Pierre en Cro√ªte d‚ÄôHerbes", "Cannelloni au Brocciu"
            ],
            "üßÄ Desserts": [
                "Assiette de Fromages Corses", "Brocciu Trompe l‚Äô≈ìil", "Brin d‚ÄôAmour Trompe l‚Äô≈ìil",
                "Pomelos", "Monte Cinto", "Fruits Confits", "Mille-Feuille de Pannetonne",
                "Tarte Pomelos", "Chocolat Noisette", "Fiadone Caram√©lis√©", "Ch√¢taigne Cl√©mentine"
            ],
            "üç∑ Mes Pr√©f√©rences (Facultatif)": [
                "Je pr√©f√®re le Vin Rouge", "Je pr√©f√®re le Vin Blanc", "Je pr√©f√®re le Ros√©",
                "J'aime les vins Doux/Sucr√©s", "J'aime les vins Puissants", "J'aime les vins L√©gers"
            ]
        };

        const input = document.getElementById('search-bar');
        const clearBtn = document.getElementById('clear-btn');
        const card = document.getElementById('response-card');
        const contentArea = document.getElementById('response-content');
        const loader = document.getElementById('loader');
        const avatarCircle = document.getElementById('avatar-circle');
        const switchButtons = document.getElementById('switch-buttons');
        const photoBtn = document.getElementById('photo-btn');
        const quickActions = document.getElementById('quick-actions');
        const feedbackContainer = document.getElementById('feedback-container');
        const legalModal = document.getElementById('legal-modal');
        const menuModal = document.getElementById('menu-modal');
        
        let currentLang = 'fr';
        let lastQuestionAsked = "";
        let currentSession = [];
        let currentWineName = "";

        const langData = {
            fr: {
                flag: "üá´üá∑", main_title: "A CASA LUNA", subtitle: "ACCORDS METS-VINS", photo_label: "Ouvrir la Carte", loader: "Recherche...", footer_quote: "L'art de vivre √† la corse.", copyright: "¬© 2026 Powered by French Sommelier. Tous droits r√©serv√©s.", phrases: ["Terrine de Figatellu", "Civet de Sanglier", "Fiadone Caram√©lis√©", "Vin corse typique"],
                quick_actions: [ 
                    { text: "Je voudrais un Rouge l√©ger", label: "üç∑ Rouge L√©ger" }, 
                    { text: "Je voudrais un Blanc Fruit√©", label: "ü•Ç Blanc Fruit√©" }, 
                    { text: "Je voudrais un Ros√© Corse", label: "üå∏ Ros√© Corse" },
                    { text: "Je voudrais un vin Rouge Puissant", label: "üçá Rouge Puissant" },
                    { text: "Je voudrais un Vin Doux / Sucr√©", label: "üçØ Vin Doux" },
                    { text: "Je voudrais un vin au Verre", label: "üç∑ Au Verre" }
                ],
                sections: { '[DEMANDE]': 'Votre repas', '[SUGGESTION]': 'Notre Suggestion', '[EXPLICATION]': "Pourquoi ce choix ?", '[AROMES]': "Au nez & en bouche", '[PROFIL_VIN]': 'Profil', '[DEGRE]': 'Caract√®re', '[AVIS]': 'Note', '[AVIS_SOMMELIER]': "Le Secret du Sommelier" }
            },
            en: {
                flag: "üá∫üá∏", main_title: "A CASA LUNA", subtitle: "WINE PAIRING", photo_label: "Open Menu", loader: "Searching...", footer_quote: "Corsican art of living.", copyright: "¬© 2026 Powered by French Sommelier. All rights reserved.", phrases: ["Wild Boar Stew", "Corsican Cheese", "Veal with Olives"],
                quick_actions: [ { text: "Light Red Wine", label: "üç∑ Light Red" }, { text: "Fruity White Wine", label: "ü•Ç Fruity White" }, { text: "Corsican Ros√©", label: "üå∏ Corsican Ros√©" }, { text: "Powerful Red Wine", label: "üçá Powerful Red" }, { text: "Sweet Wine", label: "üçØ Sweet Wine" }, { text: "Wine by the glass", label: "üç∑ By the Glass" } ],
                sections: { '[DEMANDE]': 'Your meal', '[SUGGESTION]': 'Our Suggestion', '[EXPLICATION]': "Why this choice?", '[AROMES]': "Aromas", '[PROFIL_VIN]': 'Profile', '[DEGRE]': 'Character', '[AVIS]': 'Rating', '[AVIS_SOMMELIER]': "Sommelier Secret" }
            }
        };

        function initMenu() {
            const container = document.getElementById('menu-content');
            let html = "";
            for (const [category, items] of Object.entries(menuPlats)) {
                html += `<div class="menu-category"><h3>${category}</h3>`;
                items.forEach(item => {
                    html += `<label class="menu-item">
                        <input type="checkbox" value="${item}" class="menu-checkbox" onchange="handleMenuSelection(this)">
                        <span>${item}</span>
                    </label>`;
                });
                html += `</div>`;
            }
            if(container) container.innerHTML = html;
        }

        // --- FONCTION FOCUS MENU ---
        function handleMenuSelection(checkbox) {
            const category = checkbox.closest('.menu-category');
            const items = category.querySelectorAll('.menu-item');
            
            // Calculer si au moins un √©l√©ment est coch√© dans cette cat√©gorie
            let anyChecked = false;
            const inputs = category.querySelectorAll('input');
            inputs.forEach(inp => { if(inp.checked) anyChecked = true; });

            items.forEach(item => {
                const cb = item.querySelector('input');
                if (anyChecked) {
                    // Si coch√©, on cache les autres
                    if (!cb.checked) {
                        item.style.display = 'none';
                    } else {
                        item.style.display = 'flex';
                    }
                } else {
                    // Si rien coch√©, on affiche tout
                    item.style.display = 'flex';
                }
            });
        }

        function openMenuModal() {
            if(menuModal) {
                menuModal.classList.remove('hidden');
                document.querySelectorAll('.menu-checkbox').forEach(cb => {
                    cb.checked = false;
                    cb.closest('.menu-item').style.display = 'flex';
                });
            }
        }

        function closeMenuModal() {
            if(menuModal) menuModal.classList.add('hidden');
        }

        function validerMenu() {
            const selected = [];
            document.querySelectorAll('.menu-checkbox:checked').forEach(cb => selected.push(cb.value));
            
            if (selected.length === 0) {
                alert("Veuillez s√©lectionner au moins un plat !");
                return;
            }
            
            closeMenuModal();
            input.value = selected.join(", "); 
            
            setTimeout(() => {
                const query = "Je vais manger : " + selected.join(", ") + ". Que me conseilles-tu ?";
                demanderIA(null, null, query);
            }, 50);
        }

        function setLanguage(lang) {
            currentLang = lang;
            const data = langData[lang];
            document.getElementById('current-lang-btn').innerText = data.flag;
            document.getElementById('main-title').innerText = data.main_title;
            document.getElementById('subtitle').innerText = data.subtitle;
            document.getElementById('bubble').childNodes[0].nodeValue = data.bubble;
            document.getElementById('photo-label').innerText = data.photo_label;
            document.getElementById('loader-text').innerText = data.loader;
            renderQuickActions();
            idx = 0; input.placeholder = "";
        }
        
        function renderQuickActions() {
            const actions = langData[currentLang].quick_actions;
            const container = document.getElementById('quick-actions');
            let html = `<div class="grid grid-cols-3 gap-2 w-full">`;
            actions.forEach(action => {
                html += `<button onclick="quickAction('${action.text}')" class="tag-btn w-full justify-center truncate">${action.label}</button>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function toggleTheme() {
            const b = document.body;
            const i = document.getElementById('theme-icon');
            if(b.classList.contains('theme-wine')) { b.classList.replace('theme-wine', 'theme-dark'); i.innerText = "‚òÄÔ∏è"; } else { b.classList.replace('theme-dark', 'theme-wine'); i.innerText = "üåô"; }
        }

        function toggleLegalModal() {
            if (legalModal.classList.contains('hidden')) { legalModal.classList.remove('hidden'); } else { legalModal.classList.add('hidden'); }
        }

        function handleAvatarClick() {
            window.location.reload();
        }

        input.addEventListener('input', () => { clearBtn.style.display = input.value.length > 0 ? 'block' : 'none'; });
        function clearInput() { input.value = ''; clearBtn.style.display = 'none'; input.focus(); }

        async function handlePhotoUpload(inputElement) {
            const file = inputElement.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function () { demanderIA(null, reader.result); };
        }

        function relancerIA(type) {
            let complement = "";
            if (type === 'similaire') complement = " (Propose-moi une autre suggestion dans le m√™me style)";
            if (type === 'rouge') complement = " (Je pr√©f√®re un vin Rouge avec ce plat)";
            if (type === 'blanc') complement = " (Je pr√©f√®re un vin Blanc avec ce plat)";
            if (type === 'surprends_moi') complement = " (Surprends-moi avec un style diff√©rent ou original)";
            demanderIA(null, null, complement);
        }

        function quickAction(text) { input.value = text; clearBtn.style.display = 'block'; demanderIA(); }

        async function sendFeedback(vote) {
            if (vote === 'up') { document.getElementById('btn-up').classList.add('selected'); document.getElementById('btn-down').style.display = 'none'; }
            else { document.getElementById('btn-down').classList.add('selected'); document.getElementById('btn-up').style.display = 'none'; }
            try { await fetch('/feedback', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ vote: vote, question: lastQuestionAsked }) }); } catch (e) { console.error("Erreur feedback", e); }
        }

        function getGlassSVG(filled) {
            if (filled) return `<svg xmlns="http://www.w3.org/2000/svg" class="glass-icon" viewBox="0 0 24 24" fill="#4a2c20" stroke="none"><path d="M19.8 4.2A2.2 2.2 0 0 0 17.6 2h-11a2.2 2.2 0 0 0-2.2 2.2c0 3.8 2.3 7.1 5.6 8.4V18H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2h-3v-5.4c3.3-1.3 5.8-4.6 5.8-8.4z"/></svg>`;
            else return `<svg xmlns="http://www.w3.org/2000/svg" class="glass-icon" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="2"><path d="M19.8 4.2A2.2 2.2 0 0 0 17.6 2h-11a2.2 2.2 0 0 0-2.2 2.2c0 3.8 2.3 7.1 5.6 8.4V18H7a1 1 0 0 0 0 2h10a1 1 0 0 0 0-2h-3v-5.4c3.3-1.3 5.8-4.6 5.8-8.4z"/></svg>`;
        }

        function generateWineGlasses(score) {
            let roundedScore = Math.round(score);
            let html = '<div class="flex items-center gap-1">';
            for (let i = 1; i <= 5; i++) { html += getGlassSVG(i <= roundedScore); }
            html += '</div>';
            return html;
        }

        async function demanderIA(evt, imageBase64 = null, overrideQuery = null) {
            let question = "";
            let originalQuery = input.value;

            if (overrideQuery) {
                question = `${overrideQuery} (IMPORTANT: R√©ponds UNIQUEMENT en ${currentLang === 'fr' ? 'fran√ßais' : currentLang === 'en' ? 'anglais' : 'espagnol'})`;
                originalQuery = overrideQuery;
            } else if (imageBase64) {
                // Image logic if needed
            } else {
                let rawQuestion = input.value;
                if (!rawQuestion) return;
                question = `${rawQuestion} (IMPORTANT: R√©ponds UNIQUEMENT en ${currentLang === 'fr' ? 'fran√ßais' : currentLang === 'en' ? 'anglais' : 'espagnol'})`;
            }

            // RESET UI
            quickActions.classList.add('hidden'); 
            avatarCircle.classList.add('pulse-gold'); loader.classList.remove('hidden'); photoBtn.classList.add('minimized'); contentArea.innerHTML = ""; card.classList.remove('visible'); 
            switchButtons.classList.add('hidden'); feedbackContainer.classList.add('hidden');
            document.getElementById('btn-up').classList.remove('selected'); document.getElementById('btn-down').classList.remove('selected'); document.getElementById('btn-up').style.display = 'block'; document.getElementById('btn-down').style.display = 'block';

            lastQuestionAsked = originalQuery;

            try {
                const res = await fetch('/ask', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question, image: imageBase64, context: currentSession })
                });
                const data = await res.json();
                
                if (!imageBase64 && !data.answer.includes("[ERREUR]")) {
                    currentSession.push({ role: 'user', content: question });
                    currentSession.push({ role: 'assistant', content: data.answer });
                    if (currentSession.length > 6) currentSession = currentSession.slice(currentSession.length - 6);
                }

                avatarCircle.classList.remove('pulse-gold'); loader.classList.add('hidden'); card.classList.add('visible');
                
                if (data.answer.includes("[ERREUR]")) { contentArea.innerHTML = `<div class="p-4 bg-red-50 text-red-900 rounded-xl text-base font-normal leading-snug">${data.answer.replace("[ERREUR]", "").trim()}</div>`; return; }
                
                if (data.answer.startsWith("[STOP]")) {
                    contentArea.innerHTML = `<div class="p-4 bg-red-50 text-red-800 rounded-xl text-base font-bold text-center border border-red-200 shadow-sm">${data.answer.replace("[STOP]", "").trim()}</div>`;
                    switchButtons.classList.add('hidden'); feedbackContainer.classList.add('hidden');
                    return;
                }
                
                const currentSections = langData[currentLang].sections;
                const hasTags = Object.keys(currentSections).some(tag => data.answer.includes(tag));

                if (!hasTags) {
                    contentArea.innerHTML = `<div class="p-4 bg-red-50 text-red-800 rounded-xl text-base font-bold text-center border border-red-200 shadow-sm">${data.answer}</div>`;
                    switchButtons.classList.remove('hidden'); switchButtons.classList.add('flex');
                    return;
                }

                let vinSuggere = ""; let delay = 0;

                Object.entries(currentSections).forEach(([tag, label]) => {
                    if (data.answer.includes(tag)) {
                        let rawContent = data.answer.split(tag)[1].split('[')[0];
                        rawContent = rawContent.trim().replace(/^[:\-\*\s]+/, '').trim();

                        if (rawContent === "") return;
                        let formattedContent = "";
                        let lines = [];
                        
                        if (tag === '[AVIS_SOMMELIER]' || tag === '[EXPLICATION]' || tag === '[SUGGESTION]' || tag === '[DEMANDE]') {
                            lines = rawContent.split('\n').map(l => l.trim());
                        } else if (!rawContent.includes('\n') && rawContent.includes(',') && tag !== '[AVIS]' && tag !== '[DEGRE]' && tag !== '[PRIX]') {
                            lines = rawContent.split(',').map(l => l.trim());
                        } else {
                            lines = rawContent.split('\n').map(l => l.trim());
                        }
                        
                        while (lines.length > 0) {
                            let lastLine = lines[lines.length - 1];
                            let cleanLast = lastLine.replace(/^[-*‚Ä¢]\s*/, '').replace(/\*/g, '').trim();
                            if (cleanLast === "" || cleanLast === "-" || cleanLast === "--" || cleanLast === "---") { lines.pop(); } else { break; }
                        }
                        
                        lines.forEach(line => {
                            if (line === "") { formattedContent += `<div class="h-6"></div>`; } else {
                                let cleanLine = line.replace(/^[-*‚Ä¢]\s*/, '').replace(/\*/g, '').trim();
                                if (cleanLine === "--" || cleanLine === "---" || cleanLine === "-") return;
                                if (cleanLine === "") return;
                                if (tag === '[PROFIL_VIN]') {
                                    const match = cleanLine.match(/(.*?)\s*\((\d)[\/]?5?\)/);
                                    if (match) {
                                        const text = match[1].replace(/-/g, '').replace(/\*/g, '').trim();
                                        const score = parseInt(match[2]);
                                        formattedContent += `<div class="flex justify-between items-center mb-1 last:mb-0"><span class="text-lg font-normal">${text}</span>${generateWineGlasses(score)}</div>`;
                                    } else { formattedContent += `<div class="mb-1 text-lg font-normal last:mb-0">${cleanLine.replace(/-/g, '')}</div>`; }
                                } else {
                                    let spacing = "mb-1";
                                    if (tag === '[AVIS_SOMMELIER]') spacing = "mb-4";
                                    formattedContent += `<div class="${spacing} text-lg font-normal last:mb-0">${cleanLine.replace(/^- /, '')}</div>`;
                                }
                            }
                        });

                        if (tag === '[SUGGESTION]') {
                            vinSuggere = rawContent.replace(/^[-*‚Ä¢]\s*/, '').replace(/\*/g, '').split('\n')[0].trim();
                            currentWineName = vinSuggere;
                        }
                        
                        setTimeout(() => {
                            // CR√âATION DES BO√éTES DE R√âPONSE AVEC LA CLASSE .response-box
                            const div = document.createElement('div');
                            div.className = `px-4 pt-3 pb-2 rounded-xl shadow-sm mb-3 response-box fade-in-line`;
                            div.innerHTML = `<h3 class="text-sm uppercase tracking-widest">${label}</h3>${formattedContent}`;
                            contentArea.appendChild(div);
                        }, delay);
                        delay += 300;
                    }
                });

                setTimeout(() => {
                    if (vinSuggere) {
                        switchButtons.classList.remove('hidden'); switchButtons.classList.add('flex'); feedbackContainer.classList.remove('hidden'); feedbackContainer.classList.add('flex');
                    }
                }, delay);

            } catch (e) { console.error(e); alert("Erreur de connexion serveur."); avatarCircle.classList.remove('pulse-gold'); loader.classList.add('hidden'); }
        }

        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') demanderIA(); });
        let idx = 0;
        function typeWriter() {
            let phrases = langData[currentLang].phrases;
            let p = phrases[idx % phrases.length], j = 0; input.placeholder = "";
            let t = setInterval(() => { input.placeholder += p[j++]; if (j === p.length) { clearInterval(t); setTimeout(erase, 1200); } }, 40);
        }
        function erase() {
            let c = input.placeholder;
            let t = setInterval(() => { input.placeholder = c.substring(0, c.length - 1); c = input.placeholder; if (c.length === 0) { clearInterval(t); idx++; setTimeout(typeWriter, 300); } }, 20);
        }
        
        initMenu();
        renderQuickActions(); typeWriter();
    </script>
</body>
</html>